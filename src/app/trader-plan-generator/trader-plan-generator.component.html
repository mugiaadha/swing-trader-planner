<link rel="stylesheet" href="./trader-plan-generator.mobile.css" />
<div class="container py-4 small">
  <h2 class="mb-4 fs-4">Trader Plan Generator</h2>

  <div class="card mb-4 p-4 shadow-sm">
    <form>
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Total modal (Rp)</label>
          <number-input
            [class]="'form-control form-control-sm border-none'"
            placeholder="60000000"
            [model]="totalCapital"
            (modelChange)="totalCapital = $event ?? 0; saveToStorage()"
            name="totalCapital"
          ></number-input>
        </div>
        <div class="col-md-3">
          <label class="form-label">Durasi (hari)</label>
          <number-input
            [class]="'form-control form-control-sm border-none'"
            placeholder="90"
            [model]="durationDays"
            (modelChange)="durationDays = $event ?? 0; saveToStorage()"
            name="durationDays"
          ></number-input>
        </div>
        <div class="col-md-3">
          <label class="form-label">Jumlah stage</label>
          <number-input
            [class]="'form-control form-control-sm border-none'"
            placeholder="3"
            [min]="1"
            [model]="stagesCount"
            (modelChange)="stagesCount = $event ?? 1; onStagesCountChange()"
            name="stagesCount"
          ></number-input>
        </div>
      </div>

      <div class="row g-3 mt-2">
        <div class="col-md-4">
          <label class="form-label">Alokasi tahap (OPSIONAL)</label>
          <select
            class="form-select form-select-sm"
            [(ngModel)]="allocationMode"
            name="allocationMode"
            (ngModelChange)="onAllocationModeChange()"
          >
            <option [ngValue]="'equal'">
              Equal per tahap (sisa dibagi sama rata)
            </option>
            <option [ngValue]="'custom'">Custom allocation</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Stage 0 (fix) per lot (OPSIONAL)</label>
          <number-input
            [class]="'form-control form-control-sm border-none'"
            placeholder="1"
            [min]="0"
            [model]="stage0LotsPerStock"
            (modelChange)="stage0LotsPerStock = $event ?? 0; saveToStorage()"
            name="stage0LotsPerStock"
          ></number-input>
        </div>
        <div class="col-md-4">
          <label class="form-label">Lot size (lembar per lot)</label>
          <number-input
            [class]="'form-control form-control-sm border-none'"
            placeholder="100"
            [model]="lotSize"
            (modelChange)="lotSize = $event ?? 0; saveToStorage()"
            name="lotSize"
          ></number-input>
        </div>
      </div>

      <div class="row g-2 mt-3" *ngIf="allocationMode === 'custom'">
        <div class="col-12">
          <small class="text-muted"
            >Alokasi Stage 1..N (total harus 100%)</small
          >
        </div>
        <div
          class="col-6 col-md-3"
          *ngFor="let s of getStageList(); let idx = index"
        >
          <label class="form-label">Stage {{ s }} (%)</label>
          <number-input
            [class]="'form-control'"
            [min]="0"
            [max]="100"
            [(ngModel)]="stageAllocations[idx]"
            name="stageAllocation{{ idx }}"
            (ngModelChange)="saveToStorage()"
          ></number-input>
        </div>
        <div class="col-12">
          <small
            class="text-{{
              stageAllocationsSum() === 100 ? 'success' : 'danger'
            }}"
          >
            Total: {{ stageAllocationsSum() | number : "1.0-2" }}%
          </small>
        </div>
      </div>

      <small class="text-muted d-block mt-2">
        Tahap 0 = pembelian awal (fix lots per saham). Tahap 1..N =
        cicilan/entry selanjutnya. Jika gunakan custom allocation, jumlah
        persentase harus = 100.
      </small>
    </form>
  </div>

  <div class="card mb-4 p-4 shadow-sm">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <strong>Daftar Saham</strong>
      <div>
        <button
          class="btn btn-primary btn-sm"
          type="button"
          (click)="addStock()"
        >
          + Tambah Saham
        </button>
        <button
          class="btn btn-outline-secondary btn-sm mx-2"
          type="button"
          (click)="resetStocks()"
        >
          Reset
        </button>
      </div>
    </div>
    <div class="table-responsive">
      <table
        class="table table-sm table-bordered table-hover align-middle mb-0 bg-white"
      >
        <thead class="table-light">
          <tr>
            <th style="width: 1%">#</th>
            <th style="width: 10%">Kode</th>
            <th style="width: 20%">Harga Awal</th>
            <th style="width: 20%">Bobot %</th>
            <th style="width: 10%">Aksi</th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="let stock of stocks; let i = index"
            draggable="true"
            (dragstart)="onStockDragStart(i)"
            (dragover)="onStockDragOver($event, i)"
            (drop)="onStockDrop($event, i)"
            (dragend)="onStockDragEnd()"
          >
            <td style="cursor: grab; user-select: none">
              <!-- Drag icon: SVG or emoji -->
              <span title="Drag to reorder" style="font-size: 1.2em"
                >&#x2630;</span
              >
            </td>
            <td>
              <input
                class="form-control form-control-sm"
                [(ngModel)]="stock.code"
                name="code{{ i }}"
                style="width: 100%"
                (input)="
                  stock.code = (stock.code || '').toUpperCase(); saveToStorage()
                "
              />
            </td>
            <td class="text-center">
              <number-input
                [class]="'form-control form-control-sm text-center'"
                [model]="planPrices[0][i]"
                (modelChange)="
                  planPrices[0][i] = $event ?? 0; onPriceChange(0, i)
                "
                name="price0_{{ i }}"
                placeholder="Harga awal"
              ></number-input>
            </td>
            <td>
              <number-input
                [class]="'form-control form-control-sm border-none'"
                [min]="0"
                [model]="stock.weight"
                (modelChange)="stock.weight = $event ?? 0; onWeightChange()"
                name="weight{{ i }}"
              ></number-input>
            </td>
            <td>
              <button
                class="btn btn-default text-danger"
                type="button"
                (click)="removeStock(i)"
                [disabled]="stocks.length === 1"
              >
                <span class="bi bi-trash"></span>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
      <small class="text-muted d-block mt-2">
        Total bobot: {{ stocksWeightSum() | number : "1.0-2" }}% (disarankan
        100%)
      </small>
    </div>
  </div>

  <div class="card mb-4 p-4 shadow-sm">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <strong>Hasil Rencana Trader</strong>
      <div>
        <button
          class="btn btn-success btn-sm"
          type="button"
          (click)="generatePlan()"
        >
          Calculate
        </button>
        <button
          class="btn btn-outline-success btn-sm mx-2"
          type="button"
          (click)="exportCSV()"
        >
          Export CSV
        </button>
      </div>
    </div>

    <div class="table-responsive tp-table-responsive">
      <table
        class="table table-sm table-bordered table-hover align-middle mb-0 bg-white tp-table"
      >
        <thead class="table-light">
          <tr>
            <th>Stage</th>
            <th *ngFor="let stock of stocks; let i = index" style="width: 20%">
              {{ stock.code || "STOCK " + (i + 1) }}
            </th>
          </tr>
        </thead>
        <tbody>
          <!-- Stage 0 -->
          <tr *ngIf="stage0LotsPerStock > 0">
            <td>Fase 0 (Harga Awal)</td>
            <td *ngFor="let stock of stocks; let i = index">
              <number-input
                [class]="'form-control form-control-sm mb-1'"
                [model]="planPrices[0][i]"
                (modelChange)="
                  planPrices[0][i] = $event ?? 0; onPriceChange(0, i)
                "
                name="price0_{{ i }}"
                placeholder="Harga"
              ></number-input>
              <small class="text-muted"
                >jumlah lot: {{ stage0LotsPerStock }}</small
              >
            </td>
          </tr>

          <!-- Stage 1..N -->
          <tr *ngFor="let s of getStageList(); let si = index">
            <td>Stage {{ s }}</td>
            <td *ngFor="let stock of stocks; let i = index">
              <number-input
                [class]="'form-control form-control-sm mb-1'"
                [model]="planPrices[s][i]"
                (modelChange)="
                  planPrices[s][i] = $event ?? 0; onPriceChange(s, i)
                "
                name="price{{ s }}_{{ i }}"
                placeholder="Harga"
              ></number-input>
              <small class="text-muted">jumlah lot: {{ getLots(s, i) }}</small>
            </td>
          </tr>

          <!-- Totals per stock -->
          <tr class="table-secondary">
            <td><b>Total Lot</b></td>
            <td *ngFor="let stock of stocks; let i = index">
              {{ getTotalLots(i) }}
            </td>
          </tr>
          <tr>
            <td>Avg Price/lembar</td>
            <td *ngFor="let stock of stocks; let i = index">
              {{ getAvgPricePerShare(i) | number : "1.0-0" }}
            </td>
          </tr>
          <tr>
            <td>Total Invest (Rp)</td>
            <td *ngFor="let stock of stocks; let i = index">
              {{ formatCurrency(getTotalInvestForStock(i)) }}
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <h5 class="py-2">Ringkasan:</h5>
    <div class="tp-info-summary mt-2">
      <div>
        <b>Investasi Stage 0: </b>
        <span> {{ formatCurrency(getStage0Invest()) }}</span>
      </div>
      <ng-container *ngFor="let s of getStageList(); let idx = index">
        <div>
          <b>Alokasi Stage {{ s }}:</b>
          <span> {{ formatCurrency(getStageAllocatedAmount(s)) }}</span>
          <span class="tp-info-used"
            >(terpakai: {{ formatCurrency(getStageUsedAmount(s)) }})</span
          >
        </div>
      </ng-container>
      <div>
        <b>Total invested:</b>
        <span> {{ formatCurrency(getTotalInvested()) }}</span>
      </div>
      <div>
        <b>Sisa modal (final):</b>
        <span> {{ formatCurrency(getRemainingCapital()) }}</span>
      </div>
    </div>
  </div>
</div>
